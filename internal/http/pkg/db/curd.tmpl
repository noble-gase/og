package db

import (
	"context"
	"database/sql"
	"errors"
	"log/slog"

	. "github.com/go-jet/jet/v2/mysql"
	"github.com/go-jet/jet/v2/qrm"
)

// Create 创建记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 语句示例
//	table.Demo.INSERT(table.Demo.Name).VALUES("demo")
//
//	// 创建方法
//	db.Create(ctx, db.DB(), stmt)
func Create(ctx context.Context, db *sql.DB, stmt InsertStatement) (int64, error) {
	if db == nil {
		return 0, ErrDbNil
	}

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	ret, err := stmt.ExecContext(ctx, db)
	if err != nil {
		return 0, err
	}
	return ret.LastInsertId()
}

// Update 更新记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 语句示例
//	table.Demo.UPDATE(table.Demo.Name).SET("demo").WHERE(table.Demo.ID.EQ(Int64(1)))
//
//	// 更新方法
//	db.Update(ctx, db.DB(), stmt)
func Update(ctx context.Context, db *sql.DB, stmt UpdateStatement) (int64, error) {
	if db == nil {
		return 0, ErrDbNil
	}

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	ret, err := stmt.ExecContext(ctx, db)
	if err != nil {
		return 0, err
	}
	return ret.RowsAffected()
}

// Delete 删除记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 语句示例
//	table.Demo.DELETE().WHERE(table.Demo.ID.EQ(Int64(1)))
//
//	// 删除方法
//	db.Delete(ctx, db.DB(), stmt)
func Delete(ctx context.Context, db *sql.DB, stmt DeleteStatement) error {
	if db == nil {
		return ErrDbNil
	}

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	_, err := stmt.ExecContext(ctx, db)
	return err
}

// FindOne 查询一条记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 语句示例
//	SELECT(table.Demo.AllColumns).FROM(table.Demo).WHERE(table.Demo.ID.EQ(Int64(1)))
//
//	// 查询方法
//	db.FindOne[model.Demo](ctx, db.DB(), stmt)
func FindOne[T any](ctx context.Context, db *sql.DB, stmt SelectStatement) (*T, error) {
	if db == nil {
		return nil, ErrDbNil
	}

	stmt = stmt.LIMIT(1)

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	var dest T
	if err := stmt.QueryContext(ctx, db, &dest); err != nil {
		if !errors.Is(err, qrm.ErrNoRows) {
			return nil, err
		}
		return nil, nil
	}
	return &dest, nil
}

// FindOneF 查询一条记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 查询方法
//	return db.FindOneF[model.Demo](ctx, db.DB(), func(query SelectStatement) SelectStatement {
//		return query.FROM(table.Demo.Table).WHERE(table.Demo.ID.EQ(Int64(1)))
//	}, table.Demo.AllColumns)
func FindOneF[T any](ctx context.Context, db *sql.DB, fn func(query SelectStatement) SelectStatement, columns ...Projection) (*T, error) {
	if db == nil {
		return nil, ErrDbNil
	}

	columnLen := len(columns)
	if columnLen == 0 {
		return nil, errors.New("missing table columns")
	}

	var stmt SelectStatement
	if columnLen == 1 {
		stmt = SELECT(columns[0])
	} else {
		stmt = SELECT(columns[0], columns[1:]...)
	}
	stmt = stmt.LIMIT(1)

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	var dest T
	if err := stmt.QueryContext(ctx, db, &dest); err != nil {
		if !errors.Is(err, qrm.ErrNoRows) {
			return nil, err
		}
		return nil, nil
	}
	return &dest, nil
}

// FindAll 查询多条记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 语句示例
//	SELECT(table.Demo.AllColumns).FROM(table.Demo).WHERE(table.Demo.Name.LIKE(String("%demo%")))
//
//	// 查询方法
//	db.FindAll[model.Demo](ctx, db.DB(), stmt)
func FindAll[T any](ctx context.Context, db *sql.DB, stmt SelectStatement) ([]T, error) {
	if db == nil {
		return nil, ErrDbNil
	}

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	var dest []T
	if err := stmt.QueryContext(ctx, db, &dest); err != nil {
		return nil, err
	}
	return dest, nil
}

// FindAllF 查询多条记录
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 查询方法
//	return db.FindAllF[model.Demo](ctx, db.DB(), func(query SelectStatement) SelectStatement {
//		return query.FROM(table.Demo.Table).WHERE(table.Demo.Name.LIKE(String("%demo%")))
//	}, table.Demo.AllColumns)
func FindAllF[T any](ctx context.Context, db *sql.DB, fn func(query SelectStatement) SelectStatement, columns ...Projection) ([]T, error) {
	if db == nil {
		return nil, ErrDbNil
	}

	columnLen := len(columns)
	if columnLen == 0 {
		return nil, errors.New("missing table columns")
	}

	var stmt SelectStatement
	if columnLen == 1 {
		stmt = SELECT(columns[0])
	} else {
		stmt = SELECT(columns[0], columns[1:]...)
	}

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	var dest []T
	if err := stmt.QueryContext(ctx, db, &dest); err != nil {
		return nil, err
	}
	return dest, nil
}

// Count 返回记录数
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 查询方法
//	db.Count(ctx, db.DB(), func(count SelectStatement) SelectStatement {
//		return count.FROM(table.Demo.Table).WHERE(table.Demo.Name.LIKE(String("%demo%")))
//	})
func Count(ctx context.Context, db *sql.DB, fn func(count SelectStatement) SelectStatement) (int64, error) {
	if db == nil {
		return 0, ErrDbNil
	}

	stmt := fn(SELECT(COUNT(STAR).AS("count")))

	// SQL日志
	slog.InfoContext(ctx, stmt.DebugSql())

	var total struct {
		Count int64
	}
	if err := stmt.QueryContext(ctx, db, &total); err != nil {
		return 0, err
	}
	return total.Count, nil
}

// Paginate 分页查询
//
//	// 导入模块
//	import . "github.com/go-jet/jet/v2/mysql"
//
//	// 查询方法
//	db.Paginate[model.Demo](ctx, db.DB(), func(query SelectStatement) SelectStatement {
//		return query.FROM(table.Demo.Table).WHERE(table.Demo.Name.LIKE(String("%demo%")))
//	}, page, size, table.Demo.AllColumns)
func Paginate[T any](ctx context.Context, db *sql.DB, fn func(query SelectStatement) SelectStatement, page, size int, columns ...Projection) ([]T, int64, error) {
	if db == nil {
		return nil, 0, ErrDbNil
	}

	stmtCount := fn(SELECT(COUNT(STAR).AS("count")))

	// SQL日志
	slog.InfoContext(ctx, stmtCount.DebugSql())

	var total struct {
		Count int64
	}
	if err := stmtCount.QueryContext(ctx, db, &total); err != nil {
		return nil, 0, err
	}

	var dest []T
	if total.Count > 0 {
		if page <= 0 {
			page = 1
		}
		if size <= 0 {
			size = 20
		}

		columnLen := len(columns)
		if columnLen == 0 {
			return nil, 0, errors.New("missing table columns")
		}

		var stmtQuery SelectStatement
		if columnLen == 1 {
			stmtQuery = SELECT(columns[0])
		} else {
			stmtQuery = SELECT(columns[0], columns[1:]...)
		}
		stmtQuery = fn(stmtQuery).LIMIT(int64(size)).OFFSET(int64((page - 1) * size))

		// SQL日志
		slog.InfoContext(ctx, stmtQuery.DebugSql())

		if err := stmtQuery.QueryContext(ctx, db, &dest); err != nil {
			return nil, 0, err
		}
	}
	return dest, total.Count, nil
}
